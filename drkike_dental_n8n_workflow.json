{
  "name": "drkike_dental_n8n_workflow",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [
        -304,
        0
      ],
      "id": "1bbd6f6d-a5a2-47de-94d4-072d9007c3f1",
      "name": "When chat message received",
      "webhookId": "ad70fe66-4ef9-4291-a979-c86ddea18e67"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3a26e38c-d3d4-4f86-a56b-f42ef8e7bc4a",
              "name": "user_msg",
              "value": "={{ $('When chat message received').first().json.chatInput }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -96,
        0
      ],
      "id": "fb1808aa-b2d2-4ccc-bdaf-b7b8368b1757",
      "name": "User Message"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "997e89e5-eff6-4a9b-ae94-5fbe845e42b1",
              "name": "customer.name",
              "value": "Dr. Kike",
              "type": "string"
            },
            {
              "id": "fb3c90d1-4e52-44fc-bb84-9ad2c51f6b15",
              "name": "customer.bussines",
              "value": "consultorio odontológico",
              "type": "string"
            },
            {
              "id": "2224f4b9-a1d0-4bf2-a1c6-4a79850db585",
              "name": "customer.description",
              "value": "Servicio de odontología general y especializada. Alegramos tu boca, sin entristecer tu bolsillo",
              "type": "string"
            },
            {
              "id": "3d27ce6c-b48d-4f4c-8089-a5b2433c51c6",
              "name": "customer.bussines_hours.open",
              "value": "08:00",
              "type": "string"
            },
            {
              "id": "7199f4ea-d285-4d16-8c8c-0baa4d951577",
              "name": "customer.bussines_hours.close",
              "value": "18:00",
              "type": "string"
            },
            {
              "id": "32344df0-cb5c-42ff-904e-90673e26d7ac",
              "name": "customer.bussines_hours.start_lunch_break",
              "value": "12:00",
              "type": "string"
            },
            {
              "id": "27967151-28b2-452b-900f-3a91c17145a3",
              "name": "customer.bussines_hours.end_lunch_break",
              "value": "14:00",
              "type": "string"
            },
            {
              "id": "74b278a7-b3ef-4ac2-b611-c901920f5c61",
              "name": "customer.bussines_hours.timezone",
              "value": "America/Bogota",
              "type": "string"
            },
            {
              "id": "47c2650c-1682-4eac-9604-58e86d29da8d",
              "name": "customer.bussines_hours.scheduling_threshold",
              "value": "2",
              "type": "string"
            },
            {
              "id": "3c126b83-ae24-44b1-8381-32622656c76a",
              "name": "customer.phone_number",
              "value": "573218620030",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        112,
        0
      ],
      "id": "0b7175d3-e0b6-4a6c-9935-efabeb54952a",
      "name": "Customer Context"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When chat message received').item.json.sessionId }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        416,
        256
      ],
      "id": "42ed0f88-0e08-4860-bd75-32da0fce4912",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "nQ1hEsVJOCSLTyZ1",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('User Message').first().json.user_msg }}",
        "options": {
          "systemMessage": "=## IDENTIDAD\nEres el asistente virtual de {{ $json.customer.name }}, un {{ $json.customer.bussines }}.\n{{ $json.customer.description }}\n\n## ROL\nEres un ORQUESTADOR. Tu trabajo es:\n1. Entender qué necesita el usuario\n2. Clasificar la intención en una categoría\n3. Delegar la tarea al subagente correcto\n4. NUNCA ejecutas tareas directamente, solo delegas\n\n## HORARIO DEL NEGOCIO\n- Apertura: {{ $json.customer.bussines_hours.open }}\n- Cierre: {{ $json.customer.bussines_hours.close }}\n- Almuerzo: {{ $json.customer.bussines_hours.start_lunch_break }} a {{ $json.customer.bussines_hours.end_lunch_break }}\n- Zona horaria: {{ $json.customer.bussines_hours.timezone }}\n- Umbral de agendamiento: {{ $json.customer.bussines_hours.scheduling_threshold }} horas\n\n## CATEGORÍAS DE INTENCIÓN\n1. AGENDAMIENTO - Crear, modificar, cancelar citas o consultar disponibilidad\n2. HISTORIAL - Consultar tratamientos previos, notas clínicas del paciente\n3. FACTURACIÓN - Presupuestos, pagos, cobros, deudas\n4. SEGUIMIENTO - Recordatorios, seguimiento post-tratamiento\n5. FAQ - Información general: servicios, precios, ubicación, horarios\n6. INVENTARIO - Materiales odontológicos, insumos\n\n## INSTRUCCIONES\n1. Saluda cordialmente al usuario si es su primer mensaje\n2. Analiza el mensaje del usuario\n3. Clasifica la intención en una de las 6 categorías\n4. Si la intención no es clara, haz UNA pregunta específica para clarificar\n5. Si identificas la intención, responde en formato JSON interno:\n\n## FORMATO DE RESPUESTA\nCRÍTICO: Responde SIEMPRE y ÚNICAMENTE con un objeto JSON válido.\n- NO incluyas texto antes ni después del JSON\n- NO uses bloques de código markdown (nada de ```)\n- NO incluyas explicaciones fuera del JSON\n- El campo message_to_user contiene lo que verá el usuario\n\nESTRUCTURA OBLIGATORIA:\n{\n  \"thinking\": {\n    \"intent\": \"CATEGORÍA\",\n    \"confidence\": 0.0-1.0,\n    \"sub_agent\": \"nombre_o_null\",\n    \"ready_to_delegate\": false\n  },\n  \"state\": {\n    \"user_name\": null,\n    \"intent_history\": [],\n    \"current_flow\": null,\n    \"conversation_turn\": 1,\n    \"extracted_data\": {},\n    \"pending_data\": []\n  },\n  \"message_to_user\": \"Tu mensaje cálido y conversacional aquí\"\n}\n\nVALORES VÁLIDOS PARA intent:\nAGENDAMIENTO, HISTORIAL, FACTURACION, SEGUIMIENTO, FAQ, INVENTARIO, GREETING, UNKNOWN\n\nREGLAS:\n- Si ready_to_delegate es true, sub_agent DEBE tener un valor\n- extracted_data ACUMULA todo lo recopilado durante la conversación\n- pending_data lista lo que FALTA para poder delegar\n- message_to_user es lo ÚNICO que verá el paciente, hazlo cálido y profesional\n- Máximo 2 preguntas por turno en message_to_user\n\n## ESTADO INTERNO\nMantén seguimiento de:\n- intent_history: historial de intenciones del usuario en la conversación\n- current_flow: flujo activo (ej: \"agendamiento_en_proceso\")\n- pending_data: datos que faltan por recopilar\n- user_name: nombre del usuario si lo proporciona\n\n## MENSAJE DEL USUARIO\n{{ $('User Message').first().json.user_msg }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        320,
        0
      ],
      "id": "44132f9b-4da9-4e55-a9c2-0ca6447df31e",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        288,
        208
      ],
      "id": "f1026627-42d1-4f3d-ad44-f19d6e5f09d3",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "AheJu2Tc8xuh9y2K",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Response del Orquestador\nconst rawOutput = $input.first().json.output || $input.first().json.text || '';\n\nlet parsed;\ntry {\n  // Limpiar posibles artefactos de markdown\n  let cleaned = rawOutput.trim();\n  cleaned = cleaned.replace(/^```json\\s*/i, '').replace(/^```\\s*/i, '').replace(/\\s*```$/i, '');\n  cleaned = cleaned.trim();\n  \n  // Extraer el primer objeto JSON encontrado\n  const jsonMatch = cleaned.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No JSON found');\n  }\n} catch (e) {\n  // Fallback: respuesta directa como texto\n  parsed = {\n    thinking: { \n      intent: \"UNKNOWN\", \n      confidence: 0, \n      sub_agent: null, \n      ready_to_delegate: false \n    },\n    state: { \n      user_name: null, \n      intent_history: [], \n      current_flow: null, \n      conversation_turn: 1, \n      extracted_data: {}, \n      pending_data: [] \n    },\n    message_to_user: rawOutput || \"Disculpa, ¿podrías repetirme en qué te puedo ayudar?\"\n  };\n}\n\nreturn {\n  json: {\n    // Para el routing\n    intent: parsed.thinking?.intent || \"UNKNOWN\",\n    confidence: parsed.thinking?.confidence || 0,\n    sub_agent: parsed.thinking?.sub_agent || null,\n    ready_to_delegate: parsed.thinking?.ready_to_delegate || false,\n    \n    // Estado para guardar en Postgres\n    state: parsed.state || {},\n    \n    // Mensaje para el usuario\n    message_to_user: parsed.message_to_user || \"¿En qué puedo ayudarte?\",\n    \n    // Raw para debug\n    raw_output: rawOutput\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        0
      ],
      "id": "3777282b-260e-419e-a406-cedca339c384",
      "name": "Parse Response"
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "User Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Message": {
      "main": [
        [
          {
            "node": "Customer Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Customer Context": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "6978f14b-f185-4f75-aac3-f6933f6f6583",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "477c07c3b197c01d45fc4f359fe8b6634f8c51a5c856e9ed5b49fcbc08d0d88e"
  },
  "id": "WNAJJsxROONxgP_UDv9ZH",
  "tags": []
}